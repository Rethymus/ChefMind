<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åº“è¿æ¥è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: monospace;
            margin: 0;
            padding: 20px;
            background: #1e1e1e;
            color: #fff;
            font-size: 14px;
        }
        .console {
            background: #000;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }
        .input-area {
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin: 2px;
            font-family: monospace;
        }
        .btn:hover {
            background: #1177bb;
        }
        .btn.danger {
            background: #c41e3a;
        }
        .btn.danger:hover {
            background: #e74c3c;
        }
        .btn.success {
            background: #27ae60;
        }
        .btn.success:hover {
            background: #2ecc71;
        }
        input, textarea {
            background: #1a1a1a;
            color: #fff;
            border: 1px solid #444;
            border-radius: 3px;
            padding: 5px;
            font-family: monospace;
            width: 100%;
            margin: 2px 0;
        }
        .status {
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
        }
        .success { background: #27ae60; }
        .error { background: #c41e3a; }
        .warning { background: #f39c12; color: #000; }
        .info { background: #3498db; }
        .section {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 5px;
        }
        .result {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 3px;
            padding: 10px;
            margin: 5px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .timestamp {
            color: #888;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ChefMind æ•°æ®åº“è¿æ¥è°ƒè¯•å·¥å…·</h1>

    <div class="section">
        <h3>ç¯å¢ƒæ£€æŸ¥</h3>
        <button class="btn" onclick="checkEnvironment()">æ£€æŸ¥ç¯å¢ƒ</button>
        <button class="btn" onclick="checkTauriAPI()">æ£€æŸ¥ Tauri API</button>
        <button class="btn" onclick="checkDatabaseConnection()">æ£€æŸ¥æ•°æ®åº“è¿æ¥</button>
    </div>

    <div class="section">
        <h3>æ•°æ®æŸ¥è¯¢</h3>
        <button class="btn success" onclick="queryTables()">æŸ¥è¯¢æ‰€æœ‰è¡¨</button>
        <button class="btn success" onclick="queryFavorites()">æŸ¥è¯¢æ”¶è—æ•°æ®</button>
        <button class="btn success" onclick="queryRecipes()">æŸ¥è¯¢èœè°±æ•°æ®</button>
        <button class="btn success" onclick="queryUsers()">æŸ¥è¯¢ç”¨æˆ·æ•°æ®</button>
    </div>

    <div class="section">
        <h3>è‡ªå®šä¹‰æŸ¥è¯¢</h3>
        <textarea id="customQuery" rows="3" placeholder="è¾“å…¥SQLæŸ¥è¯¢è¯­å¥...">SELECT COUNT(*) as count FROM favorites WHERE session_id = 'test_session_001'</textarea>
        <br>
        <button class="btn" onclick="executeCustomQuery()">æ‰§è¡ŒæŸ¥è¯¢</button>
        <button class="btn success" onclick="testGetFavorites()">æµ‹è¯• getFavorites æ–¹æ³•</button>
    </div>

    <div class="section">
        <h3>æµ‹è¯•æ“ä½œ</h3>
        <button class="btn" onclick="addTestFavorite()">æ·»åŠ æµ‹è¯•æ”¶è—</button>
        <button class="btn danger" onclick="removeTestFavorite()">åˆ é™¤æµ‹è¯•æ”¶è—</button>
        <button class="btn" onclick="clearConsole()">æ¸…ç©ºæ§åˆ¶å°</button>
    </div>

    <div class="console" id="console">=== æ•°æ®åº“è°ƒè¯•æ§åˆ¶å° ===
ç­‰å¾…æµ‹è¯•æ“ä½œ...</div>

    <div id="results"></div>

    <script>
        const consoleDiv = document.getElementById('console');
        const resultsDiv = document.getElementById('results');
        let testRecipeId = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#fff',
                success: '#2ecc71',
                error: '#e74c3c',
                warning: '#f39c12'
            };
            consoleDiv.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${message}</span>\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        function showResult(title, data, isError = false) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result';
            resultDiv.innerHTML = `<strong>${title}:</strong><br><pre>${JSON.stringify(data, null, 2)}</pre>`;
            if (isError) resultDiv.style.borderColor = '#e74c3c';
            resultsDiv.appendChild(resultDiv);
        }

        function clearConsole() {
            consoleDiv.innerHTML = '=== æ•°æ®åº“è°ƒè¯•æ§åˆ¶å° ===\n';
            resultsDiv.innerHTML = '';
        }

        async function checkEnvironment() {
            log('ğŸ” å¼€å§‹ç¯å¢ƒæ£€æŸ¥...', 'info');

            // æ£€æŸ¥æµè§ˆå™¨ç¯å¢ƒ
            log(`æµè§ˆå™¨: ${navigator.userAgent}`, 'info');
            log(`å¹³å°: ${navigator.platform}`, 'info');

            // æ£€æŸ¥ Tauri
            if (window.__TAURI__) {
                log('âœ… Tauri ç¯å¢ƒæ£€æµ‹æˆåŠŸ', 'success');
                log(`Tauri ç‰ˆæœ¬: ${window.__TAURI__.__version || 'æœªçŸ¥'}`, 'info');
            } else {
                log('âŒ Tauri ç¯å¢ƒæœªæ£€æµ‹åˆ°ï¼è¯·åœ¨ Tauri åº”ç”¨ä¸­è¿è¡Œæ­¤é¡µé¢', 'error');
                return;
            }

            // æ£€æŸ¥æ ¸å¿ƒ API
            try {
                const { invoke } = window.__TAURI__.core;
                log('âœ… Tauri Core API å¯ç”¨', 'success');
            } catch (error) {
                log(`âŒ Tauri Core API ä¸å¯ç”¨: ${error.message}`, 'error');
            }
        }

        async function checkTauriAPI() {
            log('ğŸ” æ£€æŸ¥ Tauri API...', 'info');

            try {
                const { invoke } = window.__TAURI__.core;

                // æµ‹è¯•ç®€å•çš„æ—¥å¿—è°ƒç”¨
                await invoke('log_message', { message: 'æ•°æ®åº“è°ƒè¯•æµ‹è¯•æ¶ˆæ¯' });
                log('âœ… Tauri invoke è°ƒç”¨æˆåŠŸ', 'success');

            } catch (error) {
                log(`âŒ Tauri API è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                showResult('Tauri API é”™è¯¯', error, true);
            }
        }

        async function checkDatabaseConnection() {
            log('ğŸ” æ£€æŸ¥æ•°æ®åº“è¿æ¥...', 'info');

            try {
                const { invoke } = window.__TAURI__.core;

                // æµ‹è¯•æ•°æ®åº“è¿æ¥ - æŸ¥è¯¢ sqlite_master
                const result = await invoke('database_query', {
                    query: "SELECT name, type FROM sqlite_master WHERE type='table'",
                    params: []
                });

                log(`âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼æ‰¾åˆ° ${result.data.length} ä¸ªè¡¨`, 'success');
                showResult('æ•°æ®åº“è¡¨åˆ—è¡¨', result.data);

                result.data.forEach(table => {
                    log(`  - ${table.name} (${table.type})`, 'info');
                });

            } catch (error) {
                log(`âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                showResult('æ•°æ®åº“è¿æ¥é”™è¯¯', error, true);
            }
        }

        async function queryTables() {
            log('ğŸ“‹ æŸ¥è¯¢æ‰€æœ‰è¡¨...', 'info');

            try {
                const { invoke } = window.__TAURI__.core;

                const result = await invoke('database_query', {
                    query: "SELECT name, type, sql FROM sqlite_master",
                    params: []
                });

                log(`âœ… æŸ¥è¯¢æˆåŠŸï¼Œè¿”å› ${result.data.length} ä¸ªå¯¹è±¡`, 'success');
                showResult('æ‰€æœ‰æ•°æ®åº“å¯¹è±¡', result.data);

            } catch (error) {
                log(`âŒ æŸ¥è¯¢è¡¨å¤±è´¥: ${error.message}`, 'error');
                showResult('æŸ¥è¯¢é”™è¯¯', error, true);
            }
        }

        async function queryFavorites() {
            log('â¤ï¸ æŸ¥è¯¢æ”¶è—æ•°æ®...', 'info');

            try {
                const { invoke } = window.__TAURI__.core;

                const result = await invoke('database_query', {
                    query: "SELECT f.*, r.title FROM favorites f LEFT JOIN recipes r ON f.recipe_id = r.id ORDER BY f.created_at DESC",
                    params: []
                });

                log(`âœ… æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° ${result.data.length} æ¡æ”¶è—è®°å½•`, 'success');
                showResult('æ”¶è—æ•°æ®', result.data);

                result.data.forEach((fav, index) => {
                    log(`  ${index + 1}. ${fav.recipe_title || fav.title || 'æœªå‘½å'} (ID: ${fav.recipe_id}, ä¼šè¯: ${fav.session_id})`, 'info');
                });

            } catch (error) {
                log(`âŒ æŸ¥è¯¢æ”¶è—å¤±è´¥: ${error.message}`, 'error');
                showResult('æŸ¥è¯¢é”™è¯¯', error, true);
            }
        }

        async function queryRecipes() {
            log('ğŸ³ æŸ¥è¯¢èœè°±æ•°æ®...', 'info');

            try {
                const { invoke } = window.__TAURI__.core;

                const result = await invoke('database_query', {
                    query: "SELECT id, title, difficulty, cooking_time FROM recipes LIMIT 10",
                    params: []
                });

                log(`âœ… æŸ¥è¯¢æˆåŠŸï¼Œè¿”å› ${result.data.length} æ¡èœè°±`, 'success');
                showResult('èœè°±æ•°æ®ï¼ˆå‰10æ¡ï¼‰', result.data);

            } catch (error) {
                log(`âŒ æŸ¥è¯¢èœè°±å¤±è´¥: ${error.message}`, 'error');
                showResult('æŸ¥è¯¢é”™è¯¯', error, true);
            }
        }

        async function queryUsers() {
            log('ğŸ‘¤ æŸ¥è¯¢ç”¨æˆ·æ•°æ®...', 'info');

            try {
                const { invoke } = window.__TAURI__.core;

                const result = await invoke('database_query', {
                    query: "SELECT session_id, created_at FROM users",
                    params: []
                });

                log(`âœ… æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° ${result.data.length} ä¸ªç”¨æˆ·`, 'success');
                showResult('ç”¨æˆ·æ•°æ®', result.data);

                result.data.forEach(user => {
                    log(`  ä¼šè¯: ${user.session_id}, åˆ›å»ºæ—¶é—´: ${user.created_at}`, 'info');
                });

            } catch (error) {
                log(`âŒ æŸ¥è¯¢ç”¨æˆ·å¤±è´¥: ${error.message}`, 'error');
                showResult('æŸ¥è¯¢é”™è¯¯', error, true);
            }
        }

        async function executeCustomQuery() {
            const query = document.getElementById('customQuery').value.trim();
            if (!query) {
                log('âŒ è¯·è¾“å…¥SQLæŸ¥è¯¢è¯­å¥', 'error');
                return;
            }

            log(`ğŸ”§ æ‰§è¡Œè‡ªå®šä¹‰æŸ¥è¯¢: ${query}`, 'info');

            try {
                const { invoke } = window.__TAURI__.core;

                const result = await invoke('database_query', {
                    query: query,
                    params: []
                });

                log(`âœ… æŸ¥è¯¢æ‰§è¡ŒæˆåŠŸï¼Œè¿”å› ${result.data.length} æ¡è®°å½•`, 'success');
                showResult('è‡ªå®šä¹‰æŸ¥è¯¢ç»“æœ', result.data);

            } catch (error) {
                log(`âŒ æŸ¥è¯¢æ‰§è¡Œå¤±è´¥: ${error.message}`, 'error');
                showResult('æŸ¥è¯¢é”™è¯¯', error, true);
            }
        }

        async function testGetFavorites() {
            log('ğŸ§ª æµ‹è¯• getFavorites æ–¹æ³•...', 'info');

            const sessionId = 'test_session_001';
            log(`ä½¿ç”¨ä¼šè¯ID: ${sessionId}`, 'info');

            try {
                const { invoke } = window.__TAURI__.core;

                // æ¨¡æ‹Ÿå‰ç«¯ getFavorites è°ƒç”¨
                const result = await invoke('database_query', {
                    query: `
                        SELECT f.*, r.title, r.description, r.ingredients, r.instructions,
                               r.cooking_time, r.difficulty, r.servings, r.category, r.tags,
                               r.nutrition_info, r.image_url, r.average_rating
                        FROM favorites f
                        LEFT JOIN recipes r ON f.recipe_id = r.id
                        WHERE f.session_id = ?
                        ORDER BY f.created_at DESC
                    `,
                    params: [sessionId]
                });

                log(`âœ… getFavorites æµ‹è¯•æˆåŠŸï¼Œè¿”å› ${result.data.length} æ¡è®°å½•`, 'success');
                showResult('getFavorites æµ‹è¯•ç»“æœ', result.data);

                if (result.data.length > 0) {
                    testRecipeId = result.data[0].recipe_id;
                    log(`è®¾ç½®æµ‹è¯•èœè°±ID: ${testRecipeId}`, 'info');
                }

            } catch (error) {
                log(`âŒ getFavorites æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                showResult('æµ‹è¯•é”™è¯¯', error, true);
            }
        }

        async function addTestFavorite() {
            log('â• æ·»åŠ æµ‹è¯•æ”¶è—...', 'info');

            try {
                const { invoke } = window.__TAURI__.core;

                // å…ˆæ‰¾ä¸€ä¸ªå¯ç”¨çš„èœè°±ID
                const recipeResult = await invoke('database_query_one', {
                    query: "SELECT id, title FROM recipes WHERE id NOT IN (SELECT recipe_id FROM favorites WHERE session_id = 'test_session_001') LIMIT 1",
                    params: []
                });

                if (!recipeResult.data) {
                    log('âŒ æ²¡æœ‰å¯ç”¨çš„èœè°±ç”¨äºæµ‹è¯•æ”¶è—', 'error');
                    return;
                }

                const recipeId = recipeResult.data.id;
                const recipeTitle = recipeResult.data.title;

                const result = await invoke('database_execute', {
                    query: "INSERT INTO favorites (session_id, recipe_id, recipe_title) VALUES (?, ?, ?)",
                    params: ['test_session_001', recipeId, recipeTitle]
                });

                log(`âœ… æˆåŠŸæ·»åŠ æ”¶è—: ${recipeTitle} (ID: ${recipeId})`, 'success');
                log(`å½±å“è¡Œæ•°: ${result.changes}, æ’å…¥ID: ${result.lastInsertId}`, 'info');

                // é‡æ–°æŸ¥è¯¢æ”¶è—
                setTimeout(() => queryFavorites(), 500);

            } catch (error) {
                log(`âŒ æ·»åŠ æ”¶è—å¤±è´¥: ${error.message}`, 'error');
                showResult('æ·»åŠ æ”¶è—é”™è¯¯', error, true);
            }
        }

        async function removeTestFavorite() {
            log('â– åˆ é™¤æµ‹è¯•æ”¶è—...', 'info');

            try {
                const { invoke } = window.__TAURI__.core;

                // åˆ é™¤æœ€æ–°çš„æ”¶è—
                const result = await invoke('database_execute', {
                    query: "DELETE FROM favorites WHERE session_id = 'test_session_001' ORDER BY created_at DESC LIMIT 1",
                    params: []
                });

                log(`âœ… æˆåŠŸåˆ é™¤æ”¶è—ï¼Œå½±å“è¡Œæ•°: ${result.changes}`, 'success');

                // é‡æ–°æŸ¥è¯¢æ”¶è—
                setTimeout(() => queryFavorites(), 500);

            } catch (error) {
                log(`âŒ åˆ é™¤æ”¶è—å¤±è´¥: ${error.message}`, 'error');
                showResult('åˆ é™¤æ”¶è—é”™è¯¯', error, true);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥ç¯å¢ƒ
        window.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ æ•°æ®åº“è°ƒè¯•å·¥å…·å·²åŠ è½½', 'info');
            log('è¯·åœ¨ Tauri åº”ç”¨ä¸­æ‰“å¼€æ­¤é¡µé¢è¿›è¡Œæµ‹è¯•', 'warning');

            // è‡ªåŠ¨æ£€æŸ¥ç¯å¢ƒ
            setTimeout(() => {
                checkEnvironment();
            }, 1000);
        });

        // æ·»åŠ å…¨å±€å‡½æ•°ä»¥ä¾¿åœ¨æ§åˆ¶å°è°ƒç”¨
        window.debugDB = {
            checkEnvironment,
            checkTauriAPI,
            checkDatabaseConnection,
            queryTables,
            queryFavorites,
            queryRecipes,
            queryUsers,
            executeCustomQuery,
            testGetFavorites,
            addTestFavorite,
            removeTestFavorite,
            clearConsole,
            log
        };
    </script>
</body>
</html>